<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('文件管理')" />
    <style>

.file-clickable
{
    display: inline-flex;
    align-items: center;
    user-select: none;
    gap: 6px;
    cursor: pointer;
    min-height: 30px;  /* 建议30-32px，和icon/font-size协调 */
}


.file-icon {
    width: 26px;
    margin-right: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
}
.file-icon i {
    font-size: 22px;
    line-height: 1;
    display: flex;
    align-items: center;
}


.file-text {
    color: inherit;
    transition: color 0.2s ease;
    white-space: nowrap;
    font-size: 16px;
    line-height: 1.1;
    display: flex;
    align-items: center;
    height: 100%;
    position: relative;
    top: 1.3px;   /* 关键：轻微下移！ */
}

        .file-text:hover {
            color: #1890ff;
        }

        .table-hover > tbody > tr:hover {
            background-color: #f2f8f7 !important;
        }


.breadcrumb-wrapper {
    display: flex;
    align-items: center;
    background: #f5f5f5;
    border: 1px solid #ccc;
    border-left: none;
    border-right: none;
    white-space: nowrap;
    gap: 8px;
    width: 60vw;
    min-width: 500px;
    max-width: 1100px;
    box-sizing: border-box;
    border-radius: 0;
    height: 32px;    /* ↓ 从48px改成32px */
    padding: 0 12px; /* 可稍微收窄，显得更紧凑 */
    font-size: 13px; /* 字号略缩小更协调 */
    overflow: hidden;
}


.breadcrumb-left {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
    flex: 1;
}



.breadcrumb-bar-area {
    display: flex;
    align-items: stretch;
    margin-top: 16px;
}

.breadcrumb-back,
.breadcrumb-refresh {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ccc;
    background: #fff;
    box-sizing: border-box;
    padding: 0;
    margin: 0;
    color: #333;
    cursor: pointer;
    width: 32px;     /* 从48px→32px */
    height: 32px;
    font-size: 15px;
}

.breadcrumb-back {
    border-right: none;
    border-radius: 4px 0 0 4px;
    position: relative;
    right: 1px;
}

.breadcrumb-refresh {
    border-left: none;
    border-radius: 0 4px 4px 0;
    position: relative;
    left: 1px;
}

.breadcrumb-segment:first-child {
    font-weight: bold;
    color: #999;
    cursor: pointer;
}

/* 如果需要“鼠标悬停按钮有底色”，可加 */
.breadcrumb-back:hover, .breadcrumb-refresh:hover {
    background: #e6e6e6;
}

        .breadcrumb-bar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .breadcrumb-segment {
            color: #1890ff;
            cursor: pointer;


            /* 加上这些行 */
            max-width: 120px;         /* 设置最大宽度，避免太长撑破 */
            overflow: hidden;         /* 溢出隐藏 */
            text-overflow: ellipsis;  /* 超出显示省略号 */
            white-space: nowrap;      /* 不换行 */
        }
        .breadcrumb-segment:hover {
            text-decoration: underline;
        }

.breadcrumb-divider {
    color: #999;
    font-weight: bold;      /* 加粗 */
    font-size: 18px;        /* 字号加大，按实际观感微调 */
    margin: 0 2px;          /* 微调分隔符间距，可选 */
    display: flex;          /* 保证垂直居中 */
    align-items: center;
}

#breadcrumb-input-prefix {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: #333;
    pointer-events: none;
    font-size: 13px;
    left: 6px;
}

.breadcrumb-input {
    width: 100%;
    border: 1px solid #aaa;
    border-radius: 4px;
    box-sizing: border-box;
    background: #f5f5f5;
    height: 32px;
    font-size: 13px;
    padding: 2px 8px;
    padding-left: 18px !important;
}
#breadcrumb-input-wrapper {
    width: 100%;
    height: 32px;
    position: relative;
}



/* 通用工具栏按钮样式 */
.action-btn {
    height: 30px;
    min-width: 68px;
    padding: 2px 16px;
    font-size: 13px;
    line-height: 1.08;
    border-radius: 4px;
    background: #fff;
    color: #333;
    border: 1px solid #ccc;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
    box-shadow: none;
    outline: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}

.action-btn:hover {
    background: #e6e6e6;
    color: #333;
    border-color: #aaa;
}

/* “新建”按钮绿色高亮（只保留一份！） */
.dropdown-unified:hover > .dropdown-toggle,
.dropdown-unified.open > .dropdown-toggle {
    background-color: #5cb85c !important;
    color: #fff !important;
    border-color: #4cae4c !important;
    border-radius: 4px !important;
    box-shadow: none !important;
}




.dropdown-menu > li > a {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    font-size: 13px;
    color: #333;
    white-space: nowrap;
}
.dropdown-menu > li > a:hover {
    background-color: #f5f5f5;
    color: #000;
}

/* 新建下拉框展开 */
.btn-group:hover > .dropdown-menu {
    display: block;
}

.dropdown-unified:hover > .dropdown-toggle .caret,
.dropdown-unified.open > .dropdown-toggle .caret {
    border-top-color: #fff;
}
.btn-group.dropdown-unified {
    position: relative;
}

/* 新建下拉菜单 */
.btn-group.dropdown-unified .dropdown-menu {
    margin-top: 0 !important;
    border-radius: 4px;
    min-width: 100%;
    box-shadow: none;
    border: 1px solid #ccc !important;
}

/* 使按钮颜色变绿 */
.btn-green-hover:hover,
.btn-green-hover:focus {
    background-color: #5cb85c !important;
    color: #fff !important;
    border-color: #4cae4c !important;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
}

.action-btns {
    display: flex;
    gap: 8px;
    margin-top: 18px; /* 增加与路径栏的间隔 */
}

@media (max-width: 600px) {

    /* 路径栏整体收紧、无横向滚动 */
    .breadcrumb-wrapper {
        width: 100% !important;
        min-width: 0 !important;
        max-width: none !important;
        height: 28px !important;      /* 跟PC缩小一点，28px更贴合 */
        font-size: 12px !important;
        padding: 0 4px !important;
        border-radius: 0 !important;
    }
    .breadcrumb-bar,
    .breadcrumb-left {
        min-width: 0 !important;
        font-size: 12px !important;
        gap: 4px !important;
    }
    .breadcrumb-segment {
        max-width: 68px !important;    /* 路径每段最长68px，超出省略号 */
        font-size: 12px !important;
        padding: 0 2px !important;
    }
    .breadcrumb-divider {
        font-size: 15px !important;
        margin: 0 1px !important;
    }
    .breadcrumb-back,
    .breadcrumb-refresh {
        height: 28px !important;
        width: 28px !important;
        font-size: 13px !important;
        line-height: 28px !important;
        padding: 0 !important;
        border-radius: 4px !important;
        margin: 0 !important;
    }

    /* Action按钮组收紧，只控制 action-btn，不动表格和其它 */
    .action-btns {
        flex-wrap: wrap !important;
        gap: 4px !important;
        margin-top: 8px !important;
    }
    .action-btn,
    .action-btn.btn-green-hover,
    .btn-danger.action-btn {
        height: 26px !important;
        min-width: 56px !important;
        font-size: 12px !important;
        padding: 1px 8px !important;
        border-radius: 4px !important;
    }
    .dropdown-menu > li > a {
        font-size: 12px !important;
        padding: 5px 10px !important;
    }
    /* 新建下拉按钮的 caret 箭头保持大小 */
    .dropdown-toggle .caret {
        margin-left: 4px !important;
        border-width: 4px 4px 0 4px !important;
    }
}


    </style>
    <link href="/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
</head>
<body class="gray-bg">
<div class="container-div">


    <div class="row">
        <div class="col-sm-12 select-table table-striped">
            <!-- 导航栏 -->
            <div class="breadcrumb-bar-area">
                <span id="breadcrumb-back" class="breadcrumb-back">
                    <i class="fa fa-arrow-left"></i>
                </span>
                <div class="breadcrumb-wrapper">
                    <div class="breadcrumb-left" id="breadcrumb-left">
                        <div id="breadcrumb-bar" class="breadcrumb-bar"></div>
                        <div id="breadcrumb-input-wrapper" style="display:none; position:relative; width:100%; height:100%;">
                            <span id="breadcrumb-input-prefix">/</span>
                            <input id="breadcrumb-input" class="breadcrumb-input" />
                        </div>
                    </div>
                </div>
                <span id="breadcrumb-refresh" class="breadcrumb-refresh">
                    <i class="fa fa-rotate-right"></i>
                </span>
            </div>

            <!-- 新建等按钮 -->
            <div class="action-btns" style="display: flex; gap: 8px;">
                <!-- 新建（带下拉） -->
                <div class="btn-group dropdown-unified">
                    <button type="button" class="btn btn-default btn-sm action-btn dropdown-toggle" data-toggle="dropdown">
                        新建 <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="javascript:;" onclick="createNewFolder()">
                                <i class="fa fa-folder"></i> 新建目录
                            </a>
                        </li>
                        <li>
                            <a href="javascript:;" onclick="createEmptyFile()">
                                <i class="fa fa-file"></i> 新建文件
                            </a>
                        </li>
                        <li>
                            <a href="javascript:;" onclick="createSymlinkFile()">
                                <i class="fa fa-link text-primary"></i> 软链接文件
                            </a>
                        </li>
                        <!-- 你可以再加其它下拉菜单项 -->
                    </ul>
                </div>
                <!-- 普通按钮 -->
                <button type="button" class="btn btn-default btn-sm action-btn btn-green-hover" onclick="uploadFile()">
                    <i class="fa fa-upload"></i> 上传
                </button>
                <button type="button" class="btn btn-default btn-sm action-btn btn-green-hover" onclick="downloadFile()">
                    <i class="fa fa-download"></i> 下载
                </button>
                <button type="button" class="btn btn-default btn-sm action-btn btn-green-hover" onclick="searchFileContent()">
                    <i class="fa fa-search"></i> 文件内容查找
                </button>
                <button type="button" class="btn btn-default btn-sm action-btn btn-green-hover" onclick="enterRecycleBin()">
                    <i class="fa fa-trash-o"></i> 回收站
                </button>
                <!-- 以后新增按钮只要加 .action-btn，自动匹配，不用动样式 -->
                <button id="delete-selected-btn"
                        type="button"
                        class="btn btn-danger btn-sm action-btn"
                        style="display: none;"
                        onclick="recycleSelectedFiles()">
                    <i class="fa fa-trash"></i> 删除选中
                </button>
            </div>

            <!-- 文件列表 -->
            <table id="bootstrap-table"></table>
        </div>
    </div>
</div>
<div th:include="include :: footer"></div>
<script th:inline="javascript">
    var prefix = ctx + "system/file";
    let isCreatingFolder = false;
    let pathStack = [
        { name: '根目录', path: '' }
    ];
    const iconMap =
    {
        0:  { icon: 'fa-file',           color: '#666' },        // 文件
        1:  { icon: 'fa-folder',         color: '#f4b400' },     // 文件夹
        2:  { icon: 'fa-file-image',     color: '#29b6f6' },     // JPG
        3:  { icon: 'fa-file-image',     color: '#29b6f6' },     // JPEG（沿用JPG样式）
        4:  { icon: 'fa-file-image',     color: '#28c76f' },     // GIF
        5:  { icon: 'fa-file-image',     color: '#00bcd4' },     // PNG
        6:  { icon: 'fa-file-image',     color: '#bca8d8' },     // BMP
        7:  { icon: 'fa-file-archive',   color: '#ff7043' },     // ZIP
        8:  { icon: 'fa-file-archive',   color: '#bf360c' },     // RAR
        9:  { icon: 'fa-file-archive',   color: '#8d6e63' },     // 7Z
        10: { icon: 'fa-file-archive',   color: '#a1887f' },     // GZ
        11: { icon: 'fa-file-lines',     color: '#90caf9' },     // TXT
        12: { icon: 'fa-file-lines',     color: '#455a64' },     // YML
        13: { icon: 'fa-file-lines',     color: '#455a64' },     // YAML（YML样式）
        14: { icon: 'fa-file-word',      color: '#1976d2' },     // DOC
        15: { icon: 'fa-file-word',      color: '#1565c0' },     // DOCX
        16: { icon: 'fa-file-pdf',       color: '#e53935' },     // PDF
        17: { icon: 'fa-file-code',      color: '#00bcd4' },     // XML
        18: { icon: 'fa-file-audio',     color: '#00e676' },     // MP3
        19: { icon: 'fa-file-video',     color: '#ab47bc' },     // MP4
        20: { icon: 'fa-file-audio',     color: '#00acc1' },     // WAV
        21: { icon: 'fa-file-audio',     color: '#00bfae' },     // FLAC
        22: { icon: 'fa-file-audio',     color: '#ffd600' },     // OGG
        23: { icon: 'fa-file-alt',       color: '#43a047' },     // EXE
        24: { icon: 'fa-file-code',      color: '#bdbdbd' },     // BAT
        25: { icon: 'fa-apple',          color: '#616161' },     // IPA
        26: { icon: 'fa-android',        color: '#a4c639' },     // APK
        27: { icon: 'fa-file-csv',       color: '#8bc34a' },     // CSV
        28: { icon: 'fa-file-code',      color: '#4caf50' },     // JSON
        29: { icon: 'fa-file-code',      color: '#ffb300' },     // HTML
        30: { icon: 'fa-file-powerpoint', color: '#ff7043' },    // PPT
        31: { icon: 'fa-file-powerpoint', color: '#ff7043' },    // PPTX
        32: { icon: 'fa-file-excel',     color: '#388e3c' },     // XLS
        33: { icon: 'fa-file-excel',     color: '#388e3c' },     // XLSX
        34: { icon: 'fa-file-image',     color: '#607d8b' },     // SVG
        35: { icon: 'fa-database',       color: '#9c27b0' },     // MDB
        36: { icon: 'fa-file-lines',     color: '#789262' }      // LOG
    };

    $(function()
    {
        var options = {
            url: prefix + "/list",
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            clickToSelect: true,
            pagination: false,

            onCheck: handleSelectionChange,
            onUncheck: handleSelectionChange,
            onCheckAll: handleSelectionChange,
            onUncheckAll: handleSelectionChange,
            columns: [{
                checkbox: true,
                formatter: function(value, row, index)
                {
                    // 返回false会隐藏checkbox，return { disabled: true } 可禁用
                    if (row.isNewFolder) return { disabled: true, checked: false }; // 禁用新建行
                    return undefined; // 其它行用默认
                }
            },
            {
                field: 'name',
                title: '文件名',
                formatter: function(value, row, index) {
                    // 新建目录的临时行
                    if (row.isNewFolder) {
                        return `
                            <div class="file-clickable">
                                <div class="file-icon">
                                    <i class="fa fa-folder" style="color: #f4b400;"></i>
                                </div>
                                <div class="file-text">
                                    <input type="text" id="new-folder-input" class="form-control input-sm" value="新建文件夹" style="width:150px;display:inline;"
                                        onkeydown="onNewFolderInputKey(event, this)"
                                        onblur="onNewFolderInputBlur(this)"
                                        maxlength="64"
                                        autofocus
                                    />
                                </div>
                            </div>
                        `;
                    }
                    // 正常文件/文件夹
                    const icon = iconMap[row.type] || iconMap[0];
                    return `
                        <div class="file-clickable" onclick="onFileClick(event, '${encodeURIComponent(row.relativePath)}')">
                            <div class="file-icon">
                                <i class="fa ${icon.icon}" style="color: ${icon.color};"></i>
                            </div>
                            <div class="file-text">
                                ${value}
                            </div>
                        </div>
                    `;
                }
            },
            {
                field : 'size',
                title : '大小',
                formatter: function(value, row, index)
                {
                    return (value === 0) ? '-' : value;
                }
            },
            {
                field : 'typeLabel',
                title : '项目类型'
            },
            {
                title: '操作',
                align: 'center',
                formatter: function(value, row, index) {
                    var actions = [];
                    actions.push('<a class="btn btn-success btn-xs" href="javascript:;"><i class="fa fa-edit"></i>重命名</a> ');
                    actions.push('<a class="btn btn-danger btn-xs" href="javascript:;" onclick="recycleSingle(\'' + encodeURIComponent(row.relativePath) + '\')"><i class="fa fa-remove"></i>删除</a>');
                    return actions.join('');
                }
            }]
        };
        $.table.init(options);
        updateBreadcrumbBar();
    });

    function onFileClick(event, relativePath)
    {
        event.stopPropagation(); // 阻止选中行
        relativePath = decodeURIComponent(relativePath);
        // console.log("点击文件：", relativePath);
        get_list(relativePath);
    }

    function get_list(relativePath)
    {
        $.post({
            url: prefix + "/list",
            data: { path: relativePath },
            success: function(res) {
                if(res.code === 0)
                {
                    $('#bootstrap-table').bootstrapTable('load', res); // 替换当前数据
                    setPathFromString(relativePath);
                }
                else
                {
                    $.modal.alertError(res.msg);
                }
                // console.log(res);
            },
            error: function(err) {
                console.error("请求失败：", err);
            }
        });
        $('#delete-selected-btn').hide();
    }

// 更新路径栏展示
function updateBreadcrumbBar()
{
    const container = document.getElementById('breadcrumb-bar');
    container.innerHTML = '';

    // 1. 计算可用宽度
    const wrapper = document.querySelector('.breadcrumb-wrapper');
    let maxWidth = wrapper.offsetWidth || 400;  // PC下给大一点兜底


    // 刷新按钮（右边那个）
    const refreshBtn = document.querySelector('.breadcrumb-refresh');
    if (refreshBtn) {
        maxWidth = maxWidth - refreshBtn.offsetWidth - 10; // 留点间隔
    }

    // ========== 移动端部分（保留你的实现） ==========
    if (window.innerWidth <= 600)
    {
        // 先测量每个segment宽度
        const temp = document.createElement('div');
        temp.style.visibility = 'hidden';
        temp.style.position = 'absolute';
        temp.style.zIndex = -1;
        temp.style.whiteSpace = 'nowrap';
        temp.style.display = 'flex';
        document.body.appendChild(temp);

        const widths = [];
        pathStack.forEach((seg, i) => {
            const segDiv = document.createElement('div');
            segDiv.className = 'breadcrumb-segment';
            segDiv.textContent = seg.name;
            temp.appendChild(segDiv);
            widths.push(segDiv.offsetWidth);
            // 分隔符也要算宽
            if (i < pathStack.length - 1) {
                const divider = document.createElement('div');
                divider.className = 'breadcrumb-divider';
                divider.textContent = '>';
                temp.appendChild(divider);
                widths.push(divider.offsetWidth);
            }
        });

        document.body.removeChild(temp);

        // 保证最后一个segment始终显示
        let totalWidth = 0;
        let startIdx = pathStack.length - 1;
        // 最后一个segment
        totalWidth += widths[widths.length - 1];
        // 逆序累加前面的segment+divider宽度，直到超maxWidth-40（预留省略号宽度）
        for (let i = widths.length - 2; i >= 0; i -= 2) { // 每次处理segment+divider
            let w_seg = widths[i - 1] || 0;
            let w_div = widths[i] || 0;
            if (totalWidth + w_seg + w_div > maxWidth - 40) break;
            totalWidth += w_seg + w_div;
            startIdx--;
        }

        // 是否有隐藏
        if (startIdx > 0)
        {
            // 加省略号
            const ellipsis = document.createElement('div');
            ellipsis.className = 'breadcrumb-segment';
            ellipsis.textContent = '«';
            ellipsis.onclick = () => {
                updateBreadcrumbBarFull();
            };
            container.appendChild(ellipsis);
        } else {
            startIdx = 0;
        }

        // 渲染可见的segment
        for (let i = startIdx; i < pathStack.length; i++)
        {
            const seg = pathStack[i];
            const partDiv = document.createElement('div');
            partDiv.className = 'breadcrumb-segment';
            partDiv.textContent = seg.name;

            partDiv.onclick = (e) => {
                e.stopPropagation();
                pathStack = pathStack.slice(0, i + 1);
                updateBreadcrumbBar();
                get_list(seg.path);
            };
            container.appendChild(partDiv);

            if (i < pathStack.length - 1) {
                const divider = document.createElement('div');
                divider.className = 'breadcrumb-divider';
                divider.textContent = '>';
                divider.onclick = (e) => e.stopPropagation();
                container.appendChild(divider);
            }
        }

    }
    // ========== PC端部分，动态宽度折叠 ==========
    else
    {
        // 先测量每个segment宽度
        const temp = document.createElement('div');
        temp.style.visibility = 'hidden';
        temp.style.position = 'absolute';
        temp.style.zIndex = -1;
        temp.style.whiteSpace = 'nowrap';
        temp.style.display = 'flex';
        document.body.appendChild(temp);

        const widths = [];
        pathStack.forEach((seg, i) => {
            const segDiv = document.createElement('div');
            segDiv.className = 'breadcrumb-segment';
            segDiv.textContent = seg.name;
            temp.appendChild(segDiv);
            widths.push(segDiv.offsetWidth);
            // 分隔符也要算宽
            if (i < pathStack.length - 1) {
                const divider = document.createElement('div');
                divider.className = 'breadcrumb-divider';
                divider.textContent = '>';
                temp.appendChild(divider);
                widths.push(divider.offsetWidth);
            }
        });

        document.body.removeChild(temp);

        // 保证最后一个segment始终显示
        let totalWidth = 0;
        let startIdx = pathStack.length - 1;
        totalWidth += widths[widths.length - 1];
        for (let i = widths.length - 2; i >= 0; i -= 2) {
            let w_seg = widths[i - 1] || 0;
            let w_div = widths[i] || 0;
            if (totalWidth + w_seg + w_div > maxWidth - 80) break; // 预留省略号宽度（PC可略大如60）
            totalWidth += w_seg + w_div;
            startIdx--;
        }

        if (startIdx > 0)
        {
            // 省略号
            const ellipsis = document.createElement('div');
            ellipsis.className = 'breadcrumb-segment';
            ellipsis.textContent = '«';
            ellipsis.onclick = () => {
                updateBreadcrumbBarFull();
            };
            container.appendChild(ellipsis);
        } else {
            startIdx = 0;
        }

        // 渲染可见的segment
        for (let i = startIdx; i < pathStack.length; i++)
        {
            const seg = pathStack[i];
            const partDiv = document.createElement('div');
            partDiv.className = 'breadcrumb-segment';
            partDiv.textContent = seg.name;

            partDiv.onclick = (e) => {
                e.stopPropagation();
                pathStack = pathStack.slice(0, i + 1);
                updateBreadcrumbBar();
                get_list(seg.path);
            };
            container.appendChild(partDiv);

            if (i < pathStack.length - 1) {
                const divider = document.createElement('div');
                divider.className = 'breadcrumb-divider';
                divider.textContent = '>';
                divider.onclick = (e) => e.stopPropagation();
                container.appendChild(divider);
            }
        }
    }
}



    function updateBreadcrumbBarFull() {
        const container = document.getElementById('breadcrumb-bar');
        container.innerHTML = '';

        pathStack.forEach((segment, index) => {
            const partDiv = document.createElement('div');
            partDiv.className = 'breadcrumb-segment';
            partDiv.textContent = segment.name;

            partDiv.onclick = (e) => {
                e.stopPropagation();
                pathStack = pathStack.slice(0, index + 1);
                updateBreadcrumbBar();
                get_list(segment.path);
            };

            container.appendChild(partDiv);

            if (index < pathStack.length - 1) {
                const divider = document.createElement('div');
                divider.className = 'breadcrumb-divider';
                divider.textContent = '>';
                divider.onclick = (e) => e.stopPropagation();
                container.appendChild(divider);
            }
        });
    }


    // 解析路径字符串并更新 pathStack
    function setPathFromString(fullPath) {
        // 替换所有反斜杠为正斜杠（防止平台兼容问题）
        const normalizedPath = fullPath.replace(/\\/g, '/');
        const parts = normalizedPath.split('/').filter(part => part !== '');

        pathStack = [];

        let cumulativePath = '';
        pathStack.push({ name: '根目录', path: '' }); // 根路径

        for (let i = 0; i < parts.length; i++) {
            cumulativePath += (cumulativePath ? '/' : '') + parts[i];
            pathStack.push({ name: parts[i], path: cumulativePath });
        }

        updateBreadcrumbBar();
    }

    document.getElementById('breadcrumb-back').onclick = () => {
        if (pathStack.length > 1) {
            pathStack.pop();
            updateBreadcrumbBar();
            const last = pathStack[pathStack.length - 1];
            get_list(last.path);
        }
    };
    document.getElementById('breadcrumb-refresh').onclick = () => {
        const last = pathStack[pathStack.length - 1];
        get_list(last.path); // 重新请求当前路径
    };



    document.querySelector('.breadcrumb-wrapper').addEventListener('click', function(e) {
        const isSegment = e.target.classList.contains('breadcrumb-segment');
        const isDivider = e.target.classList.contains('breadcrumb-divider');
        const isInput = e.target.classList.contains('breadcrumb-input');
        if (!isSegment && !isDivider && !isInput) {
            enterEditMode();
        }
    });


    function enterEditMode() {
        document.getElementById('breadcrumb-bar').style.display = 'none';
        document.getElementById('breadcrumb-input-wrapper').style.display = 'block';
        // 初始化输入内容
        let path = pathStack[pathStack.length - 1].path || '';
        document.getElementById('breadcrumb-input').value = path.replace(/^\//, '');
        document.getElementById('breadcrumb-input').focus();
    }

    // 取消输入或回车
    function exitEditMode() {
        document.getElementById('breadcrumb-bar').style.display = 'flex';
        document.getElementById('breadcrumb-input-wrapper').style.display = 'none';
    }

    // 绑定输入框事件
    document.getElementById('breadcrumb-input').onkeydown = function(e) {
        if (e.key === 'Enter') {
            let rawPath = this.value.trim();
            if (rawPath.startsWith('/')) rawPath = rawPath.substring(1);
            exitEditMode();
            get_list(rawPath);
        } else if (e.key === 'Escape') {
            exitEditMode();
        }
    };
    document.getElementById('breadcrumb-input').onblur = function() {
        exitEditMode();
    };

// 新建下拉框部分逻辑
function createNewFolder() {
    if (isCreatingFolder) return; // 防止多次
    isCreatingFolder = true;

    // 获取表格数据
    var data = $('#bootstrap-table').bootstrapTable('getData');
    // 插入临时行
    data.push({ isNewFolder: true });
    $('#bootstrap-table').bootstrapTable('load', data);

    // 新建时清除所有选中
    $('#bootstrap-table').bootstrapTable('uncheckAll');

    setTimeout(function() {
        $('#new-folder-input').focus();
        $('#new-folder-input')[0].select();
    }, 100); // 保证渲染完
}

function onNewFolderInputKey(e, input) {
    if (e.key === 'Enter') {
        createFolderRequest(input.value.trim());
    } else if (e.key === 'Escape') {
        cancelCreateNewFolder();
    }
}

function onNewFolderInputBlur(input) {
    createFolderRequest(input.value.trim());
}

function isValidFolderName(name) {
    // 不允许空、全空格
    if (!name || !name.trim()) return false;
    // 不允许点或空格开头结尾
    if (/^[\. ]|[\. ]$/.test(name)) return false;
    // 不允许特殊字符
    if (/[\\\/:\*\?"<>\|]/.test(name)) return false;
    // 长度限制
    if (name.length > 64) return false;
    return true;
}


function createFolderRequest(folderName) {
    if (!isCreatingFolder) return;
    isCreatingFolder = false;
    if (!isValidFolderName(folderName)) {
        $.modal.alertError('文件夹名不合法，不能包含 \\/ : * ? " < > |，且不能以点或空格开头/结尾，长度不能超过64！');
        cancelCreateNewFolder();
        return;
    }
    // 发送请求
    $.post({
        url: prefix + "/mkdirs",
        data: {
            path: pathStack[pathStack.length-1].path + "/" + folderName, // 当前路径
        },
        success: function(res) {
            if (res.code === 0) {
                get_list(pathStack[pathStack.length-1].path); // 刷新
            } else {
                $.modal.alertError(res.msg || '创建失败');
                cancelCreateNewFolder();
            }
        },
        error: function() {
            $.modal.alertError('网络异常');
            cancelCreateNewFolder();
        }
    });
}

function cancelCreateNewFolder() {
    isCreatingFolder = false;
    // 删除临时行
    var data = $('#bootstrap-table').bootstrapTable('getData');
    data = data.filter(row => !row.isNewFolder);
    $('#bootstrap-table').bootstrapTable('load', data);
}


function createEmptyFile() {
    console.log("点击新建空白文件");
    // 弹窗输入文件名 or inline 插入编辑行
}

function createSymlinkFile() {
    console.log("点击新建软链接文件");
    // 可弹窗输入目标路径
}

$('.btn-group.dropdown-unified').on('mouseenter', function() {
    $(this).addClass('open');
}).on('mouseleave', function() {
    $(this).removeClass('open');
});

function handleSelectionChange() {
    const selections = $('#bootstrap-table').bootstrapTable('getSelections');
    if (selections.length > 0) {
        $('#delete-selected-btn').show();
    } else {
        $('#delete-selected-btn').hide();
    }
}

function recycleRequest(paths)
{
    $.ajax({
        url: prefix + "/recycle",
        type: "DELETE",
        contentType: "application/json",
        data: JSON.stringify({ paths: paths }), // 假设后端按 JSON 结构接收
        success: function (res)
        {
            console.log(res)
            if (res.code === 0)
            {
                $.modal.alertSuccess_callback(res.msg, function ()
                {
                    get_list(pathStack[pathStack.length - 1].path);
                },
                function ()
                {
                    get_list(pathStack[pathStack.length - 1].path);
                });
            }
            else if(res.code === 513)
            {
                $.modal.alertWarning_callback(res.msg, function ()
                {
                    get_list(pathStack[pathStack.length - 1].path);
                },
                function ()
                {
                    get_list(pathStack[pathStack.length - 1].path);
                });
            }
            else
            {
                $.modal.alertError(res.msg || "删除失败");
            }

        },
        error: function () {
            $.modal.alertError("网络异常");
        }
    });
}

function recycleSelectedFiles()
{
    const selections = $('#bootstrap-table').bootstrapTable('getSelections');
    if (selections.length === 0) return;
    $.modal.confirm(`确认删除这 ${selections.length} 项吗？`, function ()
    {
        const paths = selections.map(row => row.relativePath);
        recycleRequest(paths);
    });
}

function recycleSingle(relativePath)
{
    if (null === relativePath || relativePath === '') return;
    let path = decodeURIComponent(relativePath);
    $.modal.confirm(`确认删除 ${path} 吗？`, function ()
    {
        recycleRequest([path]);
    });
}

// 浏览回收站
function enterRecycleBin()
{
    $.modal.openTab('回收站', prefix + "/recycle_view");
}
</script>
</body>
</html>